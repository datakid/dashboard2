<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" type="image/x-icon" href="favicon.ico">
<title>Lx Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
--primary-color: #3b82f6;
--primary-light: #60a5fa;
--primary-dark: #2563eb;
--primary-ultra-light: #f0f7ff;
--primary-hover: #4f8df7;
--primary-focus: #3478f5;

--secondary-color: #0ea5e9;
--secondary-light: #38bdf8;
--secondary-dark: #0284c7;
--secondary-ultra-light: #f0f9ff;
--secondary-hover: #1aabeb;
--secondary-focus: #0d9fe1;

--success-color: #10b981;
--success-light: #34d399;
--success-dark: #059669;
--success-ultra-light: #ecfdf5;

--warning-color: #f59e0b;
--warning-light: #fbbf24;
--warning-dark: #d97706;
--warning-ultra-light: #fffbeb;

--danger-color: #ef4444;
--danger-light: #f87171;
--danger-dark: #dc2626;
--danger-ultra-light: #fef2f2;

--text-color: #334155;
--text-muted: #64748b;
--text-light: #94a3b8;
--text-xlight: #cbd5e1;
--background-color: #f8fafc;
--card-background: #ffffff;
--hover-color: #f5f9ff;

--card-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
--card-hover-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.06), 0 4px 6px -4px rgba(0, 0, 0, 0.03), 0 0 0 1px rgba(59, 130, 246, 0.08);
--floating-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 5px 10px -5px rgba(0, 0, 0, 0.04);
--button-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
--button-hover-shadow: 0 4px 8px rgba(0, 0, 0, 0.06);
--popup-shadow: 0 15px 35px rgba(0, 0, 0, 0.1), 0 5px 15px rgba(0, 0, 0, 0.07);

--total-card-background: linear-gradient(135deg, #3b82f6, #2563eb);
--total-card-text: #ffffff;
--success-gradient: linear-gradient(135deg, #10b981, #059669);
--warning-gradient: linear-gradient(135deg, #f59e0b, #d97706);
--danger-gradient: linear-gradient(135deg, #ef4444, #dc2626);

--positive-change: #10b981;
--positive-light: rgba(16, 185, 129, 0.08);
--negative-change: #ef4444;
--negative-light: rgba(239, 68, 68, 0.08);
--neutral-change: #64748b;
--neutral-light: rgba(100, 116, 139, 0.08);

--transition-fast: 200ms cubic-bezier(0.4, 0, 0.2, 1);
--transition-standard: 260ms cubic-bezier(0.4, 0, 0.2, 1);
--transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
--transition-bounce: 300ms cubic-bezier(0.34, 1.56, 0.64, 1);

--border-radius-xs: 0.25rem;
--border-radius-sm: 0.5rem;
--border-radius-md: 0.75rem;
--border-radius-lg: 1rem;
--border-radius-xl: 1.5rem;
--border-radius-pill: 9999px;

--border-light: #e2e8f0;
--border-focus: rgba(59, 130, 246, 0.2);
--border-width-thin: 1px;
--border-width-medium: 2px;
--border-width-thick: 3px;

--spacing-xs: 0.5rem;
--spacing-sm: 0.75rem;
--spacing-md: 1rem;
--spacing-lg: 1.5rem;
--spacing-xl: 2rem;
--spacing-xxl: 3rem;

--z-dropdown: 10;
--z-sticky: 20;
--z-drawer: 30;
--z-modal: 40;
--z-tooltip: 50;

--dark-background: #0f172a;
--dark-card-background: #1e293b;
--dark-text-color: #e2e8f0;
--dark-text-muted: #94a3b8;
--dark-border-light: #334155;
--dark-hover: rgba(59, 130, 246, 0.15);
}

*, *::before, *::after {
box-sizing: border-box;
}

html {
scroll-behavior: smooth;
scroll-padding-top: 2rem;
}

body {
font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
margin: 0;
padding: 2.5rem;
background-color: var(--background-color);
color: var(--text-color);
line-height: 1.6;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
text-rendering: optimizeLegibility;
font-feature-settings: "liga", "kern";
transition: background-color var(--transition-standard), color var(--transition-standard);
}

.dashboard-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 3rem;
position: relative;
}

.dashboard-header h1 {
color: var(--primary-color);
font-weight: 700;
font-size: 2.25rem;
margin: 0;
letter-spacing: -0.02em;
position: relative;
transition: color var(--transition-standard);
}

.dashboard-header h1::after {
content: '';
position: absolute;
bottom: -0.5rem;
left: 0;
width: 4rem;
height: 0.25rem;
background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
border-radius: var(--border-radius-pill);
opacity: 0.8;
transition: width var(--transition-standard), background var(--transition-standard);
}

.dashboard-header h1:hover::after {
width: 100%;
opacity: 0.9;
}

.filters {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
gap: 1.75rem;
margin-bottom: 3rem;
}

.filter-select {
width: 100%;
padding: 1rem;
border: 1px solid var(--border-light);
border-radius: var(--border-radius-md);
background-color: var(--card-background);
font-size: 0.9375rem;
font-weight: 500;
color: var(--text-color);
transition: all var(--transition-standard);
appearance: none;
background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20' fill='none'%3E%3Cpath d='M6 8L10 12L14 8' stroke='%236B7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
background-repeat: no-repeat;
background-position: right 1rem center;
padding-right: 3rem;
cursor: pointer;
box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.02);
}

.filter-select:focus {
border-color: var(--primary-color);
outline: none;
box-shadow: 0 0 0 3px var(--border-focus);
transform: scale(1.02);
}

.filter-select:hover:not(:focus) {
border-color: var(--primary-light);
background-color: var(--primary-ultra-light);
}

.filter-select.highlighted {
background-color: var(--primary-ultra-light);
border-color: var(--primary-color);
box-shadow: 0 0 0 3px var(--border-focus);
}

.filter-group {
position: relative;
}

.filter-label {
position: absolute;
top: -0.75rem;
left: 1rem;
background-color: var(--card-background);
padding: 0 0.5rem;
font-size: 0.8125rem;
font-weight: 600;
color: var(--primary-color);
z-index: 1;
transition: all var(--transition-standard);
}

.filter-group:hover .filter-label {
color: var(--primary-dark);
}

.controls-container {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 3rem;
flex-wrap: wrap;
gap: 1rem;
}

.button-group {
display: flex;
gap: 1rem;
flex-wrap: wrap;
}

.reset-button,
.explore-button,
.export-button,
.missing-button {
padding: 0.875rem 1.25rem;
border-radius: var(--border-radius-md);
font-weight: 600;
font-size: 0.9375rem;
letter-spacing: 0.01em;
transition: all var(--transition-bounce);
cursor: pointer;
border: none;
box-shadow: var(--button-shadow);
position: relative;
overflow: hidden;
display: inline-flex;
align-items: center;
justify-content: center;
gap: 0.65rem;
}
.reset-button span,
.explore-button span,
.export-button span,
.missing-button span {
    line-height: 1;
}


.reset-button::after,
.explore-button::after,
.export-button::after,
.missing-button::after {
content: '';
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(255, 255, 255, 0.1);
transform: translateY(100%);
transition: transform var(--transition-standard);
}

.reset-button {
background-color: var(--primary-color);
color: white;
}

.explore-button {
background-color: var(--primary-dark);
color: white;
}

.missing-button {
background-color: var(--secondary-dark);
color: white;
}

.export-button {
background-color: var(--secondary-color);
color: white;
}

.reset-button:hover,
.explore-button:hover,
.export-button:hover,
.missing-button:hover {
transform: translateY(-2px);
box-shadow: var(--button-hover-shadow);
}

.reset-button:hover::after,
.explore-button:hover::after,
.export-button:hover::after,
.missing-button:hover::after {
transform: translateY(0);
}

.reset-button:active,
.explore-button:active,
.export-button:active,
.missing-button:active {
transform: translateY(1px);
box-shadow: var(--button-shadow);
}

.button-icon {
width: 1.1rem;
height: 1.1rem;
transition: transform var(--transition-standard);
vertical-align: middle;
}

.reset-button:hover .button-icon,
.explore-button:hover .button-icon,
.export-button:hover .button-icon,
.missing-button:hover .button-icon {
transform: scale(1.15);
}

.stats {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
gap: 1.75rem;
margin-bottom: 3rem;
}

.stat-card {
background-color: var(--card-background);
border-radius: var(--border-radius-lg);
padding: 1.75rem;
box-shadow: var(--card-shadow);
transition: all var(--transition-standard);
overflow: hidden;
position: relative;
display: flex;
flex-direction: column;
justify-content: space-between;
border: 1px solid transparent;
}

.stat-card::before {
content: '';
position: absolute;
left: 0;
top: 0;
height: 0.25rem;
width: 100%;
background: linear-gradient(90deg, var(--primary-light), var(--primary-color));
opacity: 0;
transition: opacity var(--transition-standard);
}

.stat-card:hover {
transform: translateY(-3px);
box-shadow: var(--card-hover-shadow);
border-color: var(--border-light);
transition: transform 0.3s ease-out, box-shadow 0.3s ease-out, border-color 0.3s ease-out;
}

.stat-card:hover::before {
opacity: 0.7;
}

.stat-card-content {
display: flex;
flex-direction: column;
flex-grow: 1;
}

.stat-value {
font-size: 1.75rem;
font-weight: 700;
color: var(--primary-color);
letter-spacing: -0.02em;
transition: color var(--transition-standard), transform var(--transition-standard);
margin-bottom: 0.25rem;
overflow-wrap: break-word;
word-break: break-word;
line-height: 1.2;
}

.stat-card:hover .stat-value {
transform: scale(1.05);
transform-origin: left center;
}

.stat-label {
font-size: 1rem;
color: var(--text-muted);
font-weight: 500;
transition: color var(--transition-standard);
margin-bottom: var(--spacing-md);
}

.stat-card-footer {
margin-top: auto;
}

.stat-percentage {
font-size: 0.9rem;
font-weight: 600;
color: var(--primary-color);
line-height: 1;
margin-bottom: var(--spacing-xs);
display: block;
}

.teal-card .stat-percentage {
    color: var(--secondary-dark);
}

.stat-progress-container {
width: 100%;
height: 8px;
background-color: var(--border-light);
border-radius: var(--border-radius-pill);
overflow: hidden;
}

.stat-progress-bar {
height: 100%;
width: 0%;
border-radius: var(--border-radius-pill);
transition: width 0.7s ease-out, background-color var(--transition-standard);
}

.teal-card .stat-value { color: var(--secondary-dark); }
.teal-card::before {
    background: linear-gradient(90deg, var(--secondary-light), var(--secondary-color));
}


.total-card {
background: var(--total-card-background);
color: var(--total-card-text);
grid-column: 1 / -1;
border: none;
animation: subtleScale 0.7s ease-out forwards;
}

.total-card::before {
display: none;
}

.total-card .stat-value,
.total-card .stat-label {
color: var(--total-card-text);
animation: none !important;
transform: none !important;
}
.total-card .stat-value {
font-size: 2.25rem;
margin-right: 0;
}

.total-card .stat-label {
font-size: 1.125rem;
opacity: 0.9;
font-weight: 500;
}

.chart-container {
background-color: var(--card-background);
border-radius: var(--border-radius-lg);
padding: 1.75rem;
box-shadow: var(--card-shadow);
height: 680px;
min-height: 500px;
width: 100%;
overflow: hidden;
transition: all var(--transition-standard);
border: 1px solid transparent;
position: relative;
animation: fadeIn 0.8s ease-out forwards;
}

.chart-container:hover {
transform: translateY(-5px) scale(1.01);
box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.1), 0 5px 15px -5px rgba(0, 0, 0, 0.05);
border-color: var(--border-light);
}

.chart-title {
font-size: 1.25rem;
font-weight: 600;
margin-bottom: 1.5rem;
color: var(--primary-dark);
}

.chart-controls {
position: absolute;
top: 1.75rem;
right: 1.75rem;
display: flex;
gap: 0.5rem;
}

.chart-control-btn {
background: var(--card-background);
border: 1px solid var(--border-light);
border-radius: var(--border-radius-sm);
width: 2rem;
height: 2rem;
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
transition: all var(--transition-standard);
}

.chart-control-btn:hover {
background-color: var(--primary-ultra-light);
border-color: var(--primary-light);
}

#resultsCount {
color: var(--primary-color);
font-size: 1rem;
font-weight: 600;
display: inline-flex;
align-items: center;
gap: 0.5rem;
background-color: var(--primary-ultra-light);
padding: 0.5rem 1rem;
border-radius: var(--border-radius-sm);
transition: all var(--transition-standard);
}

#resultsCount::before {
content: '';
display: inline-block;
width: 0.5rem;
height: 0.5rem;
background-color: var(--primary-color);
border-radius: 50%;
transition: transform var(--transition-fast);
}

#resultsCount:hover::before {
transform: scale(1.5);
}

.results-count-area {
    color: var(--primary-color);
    font-size: 1rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background-color: var(--primary-ultra-light);
    padding: 0.5rem 1rem;
    border-radius: var(--border-radius-sm);
    transition: all var(--transition-standard);
    margin-bottom: 1.5rem;
}

.results-count-area::before {
    content: '';
    display: inline-block;
    width: 0.5rem;
    height: 0.5rem;
    background-color: var(--primary-color);
    border-radius: 50%;
    transition: transform var(--transition-fast);
}

.results-count-area:hover::before {
    transform: scale(1.5);
}

.results-count-area.no-data {
    background-color: var(--card-background);
    color: var(--text-muted);
    border: 1px dashed var(--border-light);
}
.results-count-area.no-data::before {
    background-color: var(--text-muted);
}


.explore-table-container {
background-color: var(--card-background);
border-radius: var(--border-radius-lg);
padding: 1.75rem;
box-shadow: var(--card-shadow);
margin-top: 2.5rem;
overflow-x: auto;
border: 1px solid transparent;
transition: all var(--transition-standard);
}

.explore-table-container:hover {
box-shadow: var(--card-hover-shadow);
border-color: var(--border-light);
}

.explore-table {
width: 100%;
border-collapse: separate;
border-spacing: 0;
font-size: 0.9375rem;
}

.explore-table th,
.explore-table td {
padding: 1rem 1.25rem;
text-align: right;
border-bottom: 1px solid var(--border-light);
white-space: nowrap;
transition: background-color var(--transition-fast);
}

.explore-table th:first-child,
.explore-table td:first-child {
text-align: left;
position: sticky;
left: 0;
background-color: var(--card-background);
z-index: 1;
border-right: 1px solid var(--border-light);
font-weight: 600;
box-shadow: 2px 0 3px -1px rgba(0,0,0,0.03);
}

.explore-table th {
background-color: var(--primary-ultra-light);
font-weight: 700;
position: sticky;
top: 0;
z-index: 2;
color: var(--primary-dark);
text-transform: uppercase;
letter-spacing: 0.05em;
font-size: 0.875rem;
padding-top: 0.875rem;
padding-bottom: 0.875rem;
}
.explore-table th:first-child {
    z-index: 3;
}


.explore-table tr:last-child td {
border-bottom: none;
}

.explore-table tbody tr {
transition: all var(--transition-fast);
}

.explore-table tbody tr:hover td {
background-color: var(--hover-color);
color: var(--primary-dark);
}
.explore-table tbody tr:hover td:first-child {
    background-color: var(--hover-color);
}

.explore-table tbody tr:hover {
transform: translateX(3px);
}


.numeric-cell {
font-variant-numeric: tabular-nums;
font-feature-settings: "tnum";
text-align: right;
font-weight: 500;
}

.missing-view {
margin-top: 2.5rem;
}

#missingResultsCount {
color: var(--primary-color);
font-size: 1rem;
font-weight: 600;
display: inline-flex;
align-items: center;
gap: 0.5rem;
margin-bottom: 1.5rem;
background-color: var(--primary-ultra-light);
padding: 0.5rem 1rem;
border-radius: var(--border-radius-sm);
transition: all var(--transition-standard);
}

#missingResultsCount::before {
content: '';
display: inline-block;
width: 0.5rem;
height: 0.5rem;
background-color: var(--primary-color);
border-radius: 50%;
transition: transform var(--transition-fast);
}

#missingResultsCount:hover::before {
transform: scale(1.5);
}

.missing-table-container {
background-color: var(--card-background);
border-radius: var(--border-radius-lg);
padding: 1.75rem;
box-shadow: var(--card-shadow);
overflow-x: auto;
border: 1px solid transparent;
transition: all var(--transition-standard);
animation: fadeIn 0.6s ease-out forwards;
display: flex;
flex-direction: column;
}

.missing-table-container:hover {
box-shadow: var(--card-hover-shadow);
border-color: var(--border-light);
}

.missing-table {
width: 100%;
border-collapse: separate;
border-spacing: 0;
font-size: 0.9375rem;
margin-top: 1.5rem;
}

.missing-table th,
.missing-table td {
padding: 1rem 1.25rem;
text-align: left;
border-bottom: 1px solid var(--border-light);
white-space: nowrap;
transition: background-color var(--transition-fast);
}

.missing-table th {
background-color: var(--primary-ultra-light);
font-weight: 700;
position: sticky;
top: 0;
z-index: 2;
color: var(--primary-dark);
text-transform: uppercase;
letter-spacing: 0.05em;
font-size: 0.875rem;
padding-top: 0.875rem;
padding-bottom: 0.875rem;
}

.missing-table tr:last-child td {
border-bottom: none;
}

.missing-table tbody tr {
transition: all var(--transition-fast);
cursor: default;
}

.missing-table tbody tr:hover td {
background-color: var(--hover-color);
color: var(--primary-dark);
}
.missing-table tbody tr:hover {
transform: translateX(3px);
}

.missing-status {
display: inline-flex;
align-items: center;
justify-content: center;
font-weight: 600;
padding: 0.375rem 0.625rem;
border-radius: var(--border-radius-sm);
min-width: 2.5rem;
transition: all var(--transition-standard);
position: relative;
overflow: hidden;
}

.missing-status::before {
content: '';
display: inline-block;
width: 0.5rem;
height: 0.5rem;
border-radius: 50%;
margin-right: 0.375rem;
transition: transform var(--transition-fast);
}

.missing-high {
color: var(--negative-change);
background-color: var(--negative-light);
}

.missing-high::before {
background-color: var(--negative-change);
}

.missing-medium {
color: var(--secondary-dark);
background-color: var(--secondary-ultra-light);
}

.missing-medium::before {
background-color: var(--secondary-dark);
}

.missing-low {
color: var(--positive-change);
background-color: var(--positive-light);
}

.missing-low::before {
background-color: var(--positive-change);
}

.missing-status:hover::before {
transform: scale(1.5);
}

.missing-actions {
display: flex;
gap: 0.5rem;
}

.missing-action-btn {
background: none;
border: none;
cursor: pointer;
color: var(--primary-color);
font-size: 0.875rem;
font-weight: 600;
padding: 0.25rem 0.5rem;
border-radius: var(--border-radius-sm);
transition: all var(--transition-fast);
display: inline-flex;
align-items: center;
gap: 0.375rem;
}

.missing-action-btn:hover {
background-color: var(--primary-ultra-light);
transform: translateY(-1px);
}

.missing-action-btn:active {
transform: translateY(1px);
}

.trend-indicator {
display: inline-flex;
align-items: center;
justify-content: center;
margin-left: 0.75rem;
font-size: 0.9375rem;
font-weight: 600;
padding: 0.375rem 0.625rem;
border-radius: var(--border-radius-sm);
min-width: 2.5rem;
transition: all var(--transition-standard);
position: relative;
overflow: hidden;
}

.trend-indicator::before {
content: '';
display: inline-block;
width: 0.75rem;
height: 0.75rem;
margin-right: 0.375rem;
background-repeat: no-repeat;
background-position: center;
background-size: contain;
transition: transform var(--transition-fast);
}

.trend-up {
color: var(--positive-change);
background-color: var(--positive-light);
}

.trend-up::before {
background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%2310b981'%3E%3Cpath fill-rule='evenodd' d='M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
}

.trend-down {
color: var(--negative-change);
background-color: var(--negative-light);
}

.trend-down::before {
background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23ef4444'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
}

.trend-neutral {
color: var(--neutral-change);
background-color: var(--neutral-light);
}

.trend-neutral::before {
background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%2364748b'%3E%3Cpath fill-rule='evenodd' d='M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z' clip-rule='evenodd'/%3E%3C/svg%3E");
}

.trend-up:hover::before,
.trend-down:hover::before,
.trend-neutral:hover::before {
transform: scale(1.5);
}

.trend-up:hover,
.trend-down:hover,
.trend-neutral:hover {
filter: brightness(0.95);
transform: translateY(-1px);
}

.trend-up::after,
.missing-low::after {
content: '';
position: absolute;
top: -50%;
left: -50%;
width: 200%;
height: 200%;
background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 60%);
opacity: 0;
transform: scale(0);
transition: transform 0.6s ease-out, opacity 0.6s ease-out;
}

.trend-up:hover::after,
.missing-low:hover::after {
transform: scale(1);
opacity: 0.8;
}

.hidden {
display: none;
opacity: 0;
visibility: hidden;
transition: opacity var(--transition-standard), visibility var(--transition-standard);
}

.fadeVisible {
opacity: 1;
visibility: visible;
display: block;
}

@keyframes fadeIn {
from {
opacity: 0;
transform: translateY(5px);
}
to {
opacity: 1;
transform: translateY(0);
}
}

@keyframes slideInRight {
from {
transform: translateX(15px);
opacity: 0;
}
to {
transform: translateX(0);
opacity: 1;
}
}

@keyframes slideInLeft {
from {
transform: translateX(-15px);
opacity: 0;
}
to {
transform: translateX(0);
opacity: 1;
}
}
@keyframes subtleScale {
from {
transform: scale(0.98);
opacity: 0;
}
to {
transform: scale(1);
opacity: 1;
}
}

@keyframes scaleUp {
from {
transform: scale(0.95);
opacity: 0;
}
to {
transform: scale(1);
opacity: 1;
}
}

@keyframes shimmer {
0% {
background-position: -1000px 0;
}
100% {
background-position: 1000px 0;
}
}

.stat-card:nth-child(odd) {
animation: slideInLeft 0.6s ease-out forwards;
}

.stat-card:nth-child(even) {
animation: slideInRight 0.6s ease-out forwards;
}

.stat-card:nth-child(1) { animation-delay: 0.1s; }
.stat-card:nth-child(2) { animation-delay: 0.15s; }
.stat-card:nth-child(3) { animation-delay: 0.2s; }
.stat-card:nth-child(4) { animation-delay: 0.25s; }
.stat-card:nth-child(5) { animation-delay: 0.3s; }
.stat-card:nth-child(6) { animation-delay: 0.35s; }


.loading {
position: relative;
overflow: hidden;
}

.loading::before {
content: '';
position: absolute;
top: 0;
right: 0;
bottom: 0;
left: 0;
background: linear-gradient(to right, transparent 0%, rgba(255, 255, 255, 0.1) 50%, transparent 100%);
background-size: 1000px 100%;
animation: shimmer 2s infinite linear;
}

.reset-button::before,
.explore-button::before,
.export-button::before,
.missing-button::before {
content: '';
position: absolute;
top: 50%;
left: 50%;
width: 300%;
height: 300%;
background: rgba(255, 255, 255, 0.15);
border-radius: 50%;
transform: translate(-50%, -50%) scale(0);
transition: transform 0.6s ease;
z-index: 1;
}

.reset-button:hover::before,
.explore-button:hover::before,
.export-button:hover::before,
.missing-button:hover::before {
transform: translate(-50%, -50%) scale(1);
}

.reset-button span,
.explore-button span,
.export-button span,
.missing-button span {
position: relative;
z-index: 2;
}

button:focus,
.filter-select:focus {
outline: none;
box-shadow: 0 0 0 3px var(--border-focus), 0 0 0 5px rgba(59, 130, 246, 0.1);
}

body,
.stat-card,
.chart-container,
.filter-select,
.explore-table-container,
.missing-table-container,
.explore-table th,
.explore-table td,
.missing-table th,
.missing-table td,
.trend-indicator,
.missing-status {
transition: background-color 0.3s ease-out, color 0.3s ease-out, border-color 0.3s ease-out, box-shadow 0.3s ease-out;
}


@media (prefers-reduced-motion: reduce) {
*,
*::before,
*::after {
animation-duration: 0.01ms !important;
animation-iteration-count: 1 !important;
transition-duration: 0.01ms !important;
scroll-behavior: auto !important;
}

.stat-card,
.chart-container,
.explore-table-container,
.missing-table-container,
.stat-card:hover,
.chart-container:hover {
animation: none !important;
transform: none !important;
}

.loading::before {
animation: none !important;
}
}
</style>

</head>
<body>
<div class="dashboard-header">
<h1>Dashboard</h1>
</div>
<div class="filters">
<div class="filter-group">
<label for="regionFilter" class="filter-label">Region</label>
<select id="regionFilter" class="filter-select">
<option value="all">All Regions</option>
</select>
</div>
<div class="filter-group">
<label for="pharmacyFilter" class="filter-label">Pharmacy</label>
<select id="pharmacyFilter" class="filter-select">
<option value="all">All Pharmacies</option>
</select>
</div>
<div class="filter-group">
<label for="monthFilter" class="filter-label">Month</label>
<select id="monthFilter" class="filter-select">
<option value="all">All Months</option>
</select>
</div>
<div class="filter-group">
<label for="classFilter" class="filter-label">Class</label>
<select id="classFilter" class="filter-select">
<option value="all">All Classes</option>
<option value="student">Student</option>
<option value="workforce">Workforce</option>
</select>
</div>
</div>
<div class="controls-container">
<div class="button-group">
<button class="reset-button" id="resetFiltersBtn">
<svg class="button-icon" viewBox="0 0 20 20" fill="currentColor"  aria-hidden="true"><path fill-rule="evenodd" d="M15.322 15.322C13.94 16.704 12.008 17.5 10 17.5C6.005 17.5 2.764 14.547 2.515 10.623A.5.5 0 013 10.5H4.568a.5.5 0 01.494.563C5.251 13.46 7.378 15.5 10 15.5c1.603 0 3.07-.774 4.006-2.022a.5.5 0 01.758-.098l1.267 1.014a.5.5 0 01-.099.758zm-10.644-10.644C6.06 3.296 7.992 2.5 10 2.5c3.995 0 7.236 2.953 7.485 6.877a.5.5 0 01-.492.623H15.432a.5.5 0 01-.494-.563C14.749 6.54 12.622 4.5 10 4.5c-1.603 0-3.07.774-4.006 2.022a.5.5 0 01-.758.098L4.029 5.606a.5.5 0 01.099-.758z" clip-rule="evenodd" /></svg>
<span>Reset Filters</span>
</button>
<button class="explore-button" id="toggleExploreBtn">
<svg class="button-icon" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
<span>Explore</span>
</button>
<button class="missing-button" id="toggleMissingBtn">
<svg class="button-icon" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
<span>Missing</span>
</button>
<button class="export-button" id="exportExcelBtn">
<svg class="button-icon" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
<span>Export to Excel</span>
</button>
<button class="explore-button" id="import" onclick="window.open('https://josn.vercel.app/', '_blank')">
<svg class="button-icon" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.707 8.293a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 6.414V13a1 1 0 11-2 0V6.414L7.707 8.293a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
<span>Import JSON</span>
</button>
</div>
<div class="results-info">
<div id="resultsCount"></div>
<div id="missingResultsCount" class="hidden"></div>
</div>
</div>
<div class="dashboard-view">
<div class="stats" id="statsContainer"></div>
<div class="chart-container">
<canvas id="medicationChart"></canvas>
</div>
</div>
<div class="explore-view hidden">
<div id="exploreResultsCount" class="results-count-area"></div>
<div class="explore-table-container">
<table class="explore-table" id="exploreTable">
<thead>
<tr>
<th>Metric</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<div class="missing-view hidden">
<div id="missingViewResultsCount" class="results-count-area"></div>
<div class="missing-table-container">
<table class="missing-table" id="missingTable">
<thead>
<tr>
<th>Region</th>
<th>Pharmacy</th>
<th>Month</th>
<th>Status</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<script>
const monthOrder = {
july: 1, august: 2, september: 3, october: 4, november: 5, december: 6,
january: 7, february: 8, march: 9, april: 10, may: 11, june: 12,
'يوليو': 1, 'أغسطس': 2, 'سبتمبر': 3, 'أكتوبر': 4, 'نوفمبر': 5, 'ديسمبر': 6,
'يناير': 7, 'فبراير': 8, 'مارس': 9, 'أبريل': 10, 'مايو': 11, 'يونيو': 12,
};

const getMonthOrderValue = (month) => month ? monthOrder[String(month).trim().toLowerCase()] || 99 : 99;

let data = [], filteredData = [], missingData = [];
let totalUniquePharmaciesAllData = 0;
const medicationCategories = [
'المسكنات', 'مضادات حيوية', 'كلي', 'نفسية و عصبية', 'قلب', 'سكر حقن',
'سكر فم', 'نسا', 'كبد', 'جهاز هضمي', 'جهاز تنفسي', 'امراض جلدية',
'عيون و رمد', 'انف و اذن', 'مضادات تقلصات', 'اورام', 'فيتامينات', 'مختلفة',
];
let currentChart = null;
let isExploreMode = false;
let isMissingMode = false;

const debounce = (func, wait) => {
let timeout;
return (...args) => {
clearTimeout(timeout);
timeout = setTimeout(() => func(...args), wait);
};
};

const getCurrentFilters = () => ({
Region: document.getElementById('regionFilter').value,
Pharmacy: document.getElementById('pharmacyFilter').value,
Month: document.getElementById('monthFilter').value,
Class: document.getElementById('classFilter').value,
});

const getAvailableOptions = (field, currentFilters) => {
const uniqueValues = new Set();
data.forEach((row) => {
if (Object.entries(currentFilters).every(([key, value]) =>
value === 'all' || key === field || row[key] === value)) {
uniqueValues.add(row[field] ? String(row[field]).trim() : row[field]);
}
});
return Array.from(uniqueValues).filter(val => val !== null && val !== undefined && String(val).trim() !== '').sort((a, b) => {
if (field === 'Month') return getMonthOrderValue(a) - getMonthOrderValue(b);
return String(a).localeCompare(String(b));
});
};

const updateFilterHighlights = () => {
const currentFilters = getCurrentFilters();
Object.entries(currentFilters).forEach(([key, value]) => {
const filterElement = document.getElementById(`${key.toLowerCase()}Filter`);
if (filterElement) {
    if (value !== 'all') filterElement.classList.add('highlighted');
    else filterElement.classList.remove('highlighted');
}
});
};


const updateFilterOptions = (filterName, currentFilters) => {
const select = document.getElementById(`${filterName}Filter`);
if (!select) return;
const currentValue = select.value;
const fieldName = filterName.charAt(0).toUpperCase() + filterName.slice(1);
const availableOptions = getAvailableOptions(fieldName, currentFilters);
select.innerHTML = `<option value="all">All ${fieldName}s</option>`;
availableOptions.forEach((option) => {
const optElement = document.createElement('option');
optElement.value = option;
optElement.textContent = option;
select.appendChild(optElement);
});

const currentSelectedValueStillAvailable = availableOptions.includes(currentValue);
if (currentValue !== 'all' && currentSelectedValueStillAvailable) {
    select.value = currentValue;
} else if (currentValue !== 'all' && !currentSelectedValueStillAvailable) {
    select.value = 'all';
} else {
    select.value = 'all';
}
};


const initializeFilters = () => {
const filters = ['region', 'pharmacy', 'month', 'class'];
filters.forEach((filter) => {
const filterElement = document.getElementById(`${filter}Filter`);
if (filterElement) {
    filterElement.addEventListener('change', () => {
        updateFilterHighlights();
        const currentFilters = getCurrentFilters();
        filters.forEach((otherFilter) => {
             if (otherFilter !== filter) updateFilterOptions(otherFilter, currentFilters);
        });
        updateFilterOptions(filter, {});
        updateDashboard();
    });
}
});
const currentFilters = getCurrentFilters();
filters.forEach((filter) => updateFilterOptions(filter, {}));
updateFilterHighlights();
};

const getTrendIndicator = (current, previous) => {
if (previous === null || current === null || isNaN(current) || isNaN(previous)) return '';
if (current === previous) return '<span class="trend-indicator trend-neutral">→</span>';
return current > previous
? '<span class="trend-indicator trend-up">↑</span>'
: '<span class="trend-indicator trend-down">↓</span>';
};

const updateExploreView = () => {
const table = document.getElementById('exploreTable');
const thead = table.querySelector('thead tr');
const tbody = table.querySelector('tbody');
const resultsCountElement = document.getElementById('exploreResultsCount');


const months = Array.from(new Set(filteredData.map((row) => row.Month ? String(row.Month).trim() : row.Month)))
    .filter(Boolean)
    .sort((a, b) => getMonthOrderValue(a) - getMonthOrderValue(b));

thead.innerHTML = '<th>Metric</th>';
months.forEach((month) => { thead.innerHTML += `<th class="numeric-cell">${month}</th>`; });

const metrics = ['Total', 'Total Prescriptions', 'Insurance Covered', 'Active Pharmacies', ...medicationCategories];
const monthlyData = {};

months.forEach((month) => {
const monthData = filteredData.filter((row) => (row.Month ? String(row.Month).trim() : row.Month) === month);
monthlyData[month] = {
Total: medicationCategories.reduce((sum, category) => sum + monthData.reduce((catSum, row) => catSum + parseFloat(row[category] || 0), 0), 0),
'Total Prescriptions': monthData.reduce((sum, row) => sum + parseFloat(row['Total Prescription'] || 0), 0),
'Insurance Covered': monthData.reduce((sum, row) => sum + parseFloat(row['Insurance Covered Prescription'] || 0), 0),
'Active Pharmacies': new Set(monthData.map((row) => row.Pharmacy).filter(Boolean)).size,
...Object.fromEntries(medicationCategories.map((category) => [category, monthData.reduce((sum, row) => sum + parseFloat(row[category] || 0), 0)])),
};
});
tbody.innerHTML = '';
let displayedMetricsCount = 0;
metrics.forEach((metric) => {
const row = document.createElement('tr');
row.innerHTML = `<td>${metric}</td>`;
let previousValue = null;
let hasData = false;
months.forEach((month) => {
const value = monthlyData[month][metric];
if (value !== 0 && value !== undefined) hasData = true;
const trend = getTrendIndicator(value, previousValue);
row.innerHTML += `<td class="numeric-cell">${typeof value === 'number' ? value.toLocaleString(undefined, {maximumFractionDigits:3}) : value} ${trend}</td>`;
previousValue = value;
});
if(hasData || metric === 'Active Pharmacies' || metric === 'Total Prescriptions' || metric === 'Insurance Covered' || metric === 'Total') {
    tbody.appendChild(row);
    displayedMetricsCount++;
}
});
 if (resultsCountElement) {
    resultsCountElement.textContent = months.length > 0 ? `Explore view: Showing ${displayedMetricsCount} metrics across ${months.length} month(s).` : 'Explore view: No data to display for current filters.';
    resultsCountElement.className = 'results-count-area';
    if (months.length === 0 || displayedMetricsCount === 0) resultsCountElement.classList.add('no-data'); else resultsCountElement.classList.remove('no-data');
}
};

const findMissingTotals = () => {
missingData = [];
const allMonthsOriginal = Array.from(new Set(data.map(row => row.Month ? String(row.Month).trim() : row.Month))).filter(Boolean).sort((a, b) => getMonthOrderValue(a) - getMonthOrderValue(b));
const currentFilters = getCurrentFilters();

let monthsToCheck = currentFilters.Month !== 'all' ? [currentFilters.Month] : allMonthsOriginal;

let baseDataset = data;
if (currentFilters.Region !== 'all') baseDataset = baseDataset.filter(row => row.Region === currentFilters.Region);
if (currentFilters.Pharmacy !== 'all') baseDataset = baseDataset.filter(row => row.Pharmacy === currentFilters.Pharmacy);
if (currentFilters.Class !== 'all') baseDataset = baseDataset.filter(row => row.Class === currentFilters.Class);

const eligiblePharmacies = Array.from(new Set(baseDataset.map(row => row.Pharmacy))).filter(Boolean);
const pharmacyRegions = {};
data.forEach(row => { if (row.Pharmacy && row.Region) pharmacyRegions[String(row.Pharmacy).trim()] = String(row.Region).trim(); });

monthsToCheck.forEach(month => {
    const monthDataForEligible = baseDataset.filter(row => (row.Month ? String(row.Month).trim() : row.Month) === month);
    const activePharmaciesInMonth = new Set(monthDataForEligible.map(row => String(row.Pharmacy).trim()).filter(Boolean));

    eligiblePharmacies.forEach(pharmacy => {
        if (!activePharmaciesInMonth.has(String(pharmacy).trim())) {
            missingData.push({
                Region: pharmacyRegions[String(pharmacy).trim()] || 'Unknown',
                Pharmacy: pharmacy,
                Month: month,
                Status: 'Inactive'
            });
        }
    });
});

missingData.sort((a, b) => {
const regionCompare = String(a.Region).localeCompare(String(b.Region));
if (regionCompare !== 0) return regionCompare;
const pharmacyCompare = String(a.Pharmacy).localeCompare(String(b.Pharmacy));
if (pharmacyCompare !== 0) return pharmacyCompare;
return getMonthOrderValue(a.Month) - getMonthOrderValue(b.Month);
});
return missingData;
};


const updateMissingView = () => {
const table = document.getElementById('missingTable');
const tbody = table.querySelector('tbody');
tbody.innerHTML = '';
const resultsCountElement = document.getElementById('missingViewResultsCount');

if (resultsCountElement) {
    resultsCountElement.textContent = missingData.length > 0 ? `Missing view: ${missingData.length} inactive pharmacy instance(s) found.` : 'Missing view: No inactive pharmacies for the selected filters.';
    resultsCountElement.className = 'results-count-area';
     if (missingData.length === 0) resultsCountElement.classList.add('no-data');
}

let currentRegion = null;
let currentPharmacy = null;

missingData.forEach((item, index) => {
    const row = document.createElement('tr');
    let regionDisplay = item.Region;
    let pharmacyDisplay = item.Pharmacy;

    if (item.Region !== currentRegion) {
        let rowspanRegion = 1;
        for (let i = index + 1; i < missingData.length; i++) {
            if (missingData[i].Region === item.Region) rowspanRegion++;
            else break;
        }
        const regionCell = document.createElement('td');
        regionCell.textContent = regionDisplay;
        regionCell.rowSpan = rowspanRegion;
        row.appendChild(regionCell);
        currentRegion = item.Region;
        currentPharmacy = null;
    }

    if (item.Pharmacy !== currentPharmacy || item.Region !== (missingData[index-1] ? missingData[index-1].Region : null) ) {
         let rowspanPharmacy = 1;
         for (let i = index + 1; i < missingData.length; i++) {
             if (missingData[i].Pharmacy === item.Pharmacy && missingData[i].Region === item.Region) rowspanPharmacy++;
             else break;
         }
        const pharmacyCell = document.createElement('td');
        pharmacyCell.textContent = pharmacyDisplay;
        pharmacyCell.rowSpan = rowspanPharmacy;
        row.appendChild(pharmacyCell);
        currentPharmacy = item.Pharmacy;
    }

    const monthCell = document.createElement('td');
    monthCell.textContent = item.Month;
    row.appendChild(monthCell);

    const statusCell = document.createElement('td');
    const statusSpan = document.createElement('span');
    statusSpan.className = 'missing-status missing-high';
    statusSpan.textContent = item.Status;
    statusCell.appendChild(statusSpan);
    row.appendChild(statusCell);

    tbody.appendChild(row);
});

if (tbody.children.length === 0 && resultsCountElement && !resultsCountElement.classList.contains('no-data')) {
    const row = document.createElement('tr');
    const cell = document.createElement('td');
    cell.colSpan = 4;
    cell.textContent = 'All pharmacies are active for the selected filters.';
    cell.style.textAlign = 'center';
    row.appendChild(cell);
    tbody.appendChild(row);
}
};


const applyFilters = () => {
const currentFilters = getCurrentFilters();
filteredData = data.filter((row) =>
Object.entries(currentFilters).every(([key, value]) => {
    if (value === 'all') return true;
    const rowValue = row[key] ? String(row[key]).trim() : null;
    return rowValue === value;
})
);
};

const updateStats = () => {
const statsContainer = document.getElementById('statsContainer');
statsContainer.innerHTML = '';

const totalPrescriptions = filteredData.reduce((sum, row) => sum + parseFloat(row['Total Prescription'] || 0), 0);
const insuranceCovered = filteredData.reduce((sum, row) => sum + parseFloat(row['Insurance Covered Prescription'] || 0), 0);
const activePharmacies = new Set(filteredData.map((row) => row.Pharmacy).filter(Boolean)).size;
const totalMedicationsValue = medicationCategories.reduce((sum, category) => sum + filteredData.reduce((catSum, row) => catSum + parseFloat(row[category] || 0), 0), 0);

addStatCard('Total Medications Value', totalMedicationsValue, { cardType: 'total' });
addStatCard('Total Prescriptions', totalPrescriptions, { cardType: 'teal' });
addStatCard('Insurance Covered', insuranceCovered, { cardType: 'teal' });
addStatCard('Active Pharmacies', activePharmacies, {
    cardType: 'medication',
    percentage: totalUniquePharmaciesAllData > 0 ? (activePharmacies / totalUniquePharmaciesAllData) * 100 : 0
});

medicationCategories.forEach((category) => {
    const total = filteredData.reduce((sum, row) => sum + parseFloat(row[category] || 0), 0);
    addStatCard(category, total, {
        cardType: 'medication',
        percentage: totalMedicationsValue > 0 ? (total / totalMedicationsValue) * 100 : 0
    });
});
};

const addStatCard = (label, value, options = {}) => {
    const statsContainer = document.getElementById('statsContainer');
    const card = document.createElement('div');
    let cardClasses = 'stat-card';
    if (options.cardType === 'total') cardClasses += ' total-card';
    if (options.cardType === 'teal') cardClasses += ' teal-card';
    card.className = cardClasses;

    const numericValue = Number(value);
    const formattedValue = numericValue.toLocaleString(undefined, { maximumFractionDigits: 3 });

    let footerHTML = '';
    let progressBarColor = 'var(--primary-color)';
    let percentageColor = 'var(--primary-color)';

    if (options.cardType === 'teal') {
        progressBarColor = 'var(--secondary-dark)';
        percentageColor = 'var(--secondary-dark)';
    }


    if (options.cardType === 'medication' && options.percentage !== undefined) {
        const displayPercentage = Math.max(0, Math.min(100, parseFloat(options.percentage) || 0));
        footerHTML = `
            <div class="stat-card-footer">
                <div class="stat-percentage" style="color: ${percentageColor};">${displayPercentage.toFixed(0)}%</div>
                <div class="stat-progress-container">
                    <div class="stat-progress-bar" style="width: ${displayPercentage}%; background-color: ${progressBarColor};"></div>
                </div>
            </div>`;
    } else if ((options.cardType === 'teal' && (label === 'Total Prescriptions' || label === 'Insurance Covered')) ) {
         footerHTML = `<div class="stat-card-footer"></div>`;
    }


    card.innerHTML = `
        <div class="stat-card-content">
            <div class="stat-value">${formattedValue}</div>
            <div class="stat-label">${label}</div>
        </div>
        ${footerHTML}`;
    statsContainer.appendChild(card);
};


const updateResultsCount = () => {
document.getElementById('resultsCount').textContent = `Showing ${filteredData.length} results`;
findMissingTotals();
const missingResultsCountElement = document.getElementById('missingResultsCount');
const missingViewResultsCount = document.getElementById('missingViewResultsCount');
const exploreResultsCountElement = document.getElementById('exploreResultsCount');

if (isMissingMode && missingViewResultsCount) {
     missingViewResultsCount.textContent = missingData.length > 0 ? `Missing view: ${missingData.length} inactive pharmacy instance(s) found.` : 'Missing view: No inactive pharmacies for the selected filters.';
     if (missingData.length === 0) missingViewResultsCount.classList.add('no-data'); else missingViewResultsCount.classList.remove('no-data');
} else if (isExploreMode && exploreResultsCountElement) {
    const months = Array.from(new Set(filteredData.map((row) => row.Month ? String(row.Month).trim() : row.Month))).filter(Boolean);
    const tableBody = document.getElementById('exploreTable')?.querySelector('tbody');
    const displayedMetricsCount = tableBody ? tableBody.rows.length : 0;
    exploreResultsCountElement.textContent = months.length > 0 ? `Explore view: Showing ${displayedMetricsCount} metrics across ${months.length} month(s).` : 'Explore view: No data to display for current filters.';
    if (months.length === 0 || displayedMetricsCount === 0) exploreResultsCountElement.classList.add('no-data'); else exploreResultsCountElement.classList.remove('no-data');
} else {
    missingResultsCountElement.textContent = missingData.length > 0 ? `${missingData.length} Inactive` : '';
    if (missingData.length === 0) {
         missingResultsCountElement.classList.add('hidden');
    } else {
         missingResultsCountElement.classList.remove('hidden');
    }
}
};

const updateMedicationChart = () => {
const ctx = document.getElementById('medicationChart').getContext('2d');
if (currentChart) currentChart.destroy();

const rootStyles = getComputedStyle(document.documentElement);
const chartFontFamily = rootStyles.getPropertyValue('font-family').split(',')[0].trim() || 'Inter';

const primaryColor = rootStyles.getPropertyValue('--primary-color').trim();
const primaryLight = rootStyles.getPropertyValue('--primary-light').trim();
const primaryDark = rootStyles.getPropertyValue('--primary-dark').trim();
const textMutedColor = rootStyles.getPropertyValue('--text-muted').trim();
const borderLightColor = rootStyles.getPropertyValue('--border-light').trim();
const cardBgColor = rootStyles.getPropertyValue('--card-background').trim();
const textColor = rootStyles.getPropertyValue('--text-color').trim();

const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
gradient.addColorStop(0, primaryLight || 'rgba(96, 165, 250, 0.8)');
gradient.addColorStop(1, primaryColor || 'rgba(59, 130, 246, 0.8)');


const medicationData = medicationCategories.map((category) =>
    filteredData.reduce((sum, row) => sum + parseFloat(row[category] || 0), 0)
);

currentChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: medicationCategories,
        datasets: [{
            label: 'Medication Distribution',
            data: medicationData,
            backgroundColor: gradient,
            borderColor: primaryDark,
            borderWidth: 0,
            borderRadius: 6,
            borderSkipped: false,
            hoverBackgroundColor: primaryDark,
            barPercentage: 0.7,
            categoryPercentage: 0.75
        }],
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        layout: {
            padding: {
                right: 60
            }
        },
        scales: {
            y: {
                grid: {
                    display: false,
                    drawBorder: false,
                },
                ticks: {
                    color: textMutedColor,
                    font: { family: chartFontFamily, size: 11, weight: '500' },
                    padding: 10,
                }
            },
            x: {
                beginAtZero: true,
                grid: {
                    color: borderLightColor ? borderLightColor + '60' : 'rgba(226, 232, 240, 0.4)',
                    borderColor: borderLightColor,
                    drawBorder: false,
                    borderDash: [3, 3],
                },
                ticks: {
                    color: textMutedColor,
                    font: { family: chartFontFamily, size: 11 },
                    padding: 8,
                    maxTicksLimit: 7,
                    callback: function(value) {
                        if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                        if (value >= 1000) return (value / 1000).toFixed(0) + 'K';
                        return value.toLocaleString();
                    }
                }
            }
        },
        plugins: {
            legend: {
                display: false
            },
            title: {
                display: true,
                text: 'Medication Distribution by Category',
                color: primaryDark,
                font: {
                    size: 16,
                    weight: '600',
                    family: chartFontFamily
                },
                padding: {
                    top: 5,
                    bottom: 25
                }
            },
            tooltip: {
                enabled: true,
                backgroundColor: cardBgColor,
                titleColor: primaryColor,
                titleFont: { family: chartFontFamily, weight: '600', size: 14 },
                bodyColor: textColor,
                bodyFont: { family: chartFontFamily, size: 12 },
                borderColor: primaryLight,
                borderWidth: 1,
                padding: 12,
                cornerRadius: 8,
                usePointStyle: true,
                boxPadding: 3,
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        if (context.parsed.x !== null) {
                            label += Number(context.parsed.x).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 3});
                        }
                        return label;
                    }
                }
            },
            afterDraw: (chartInstance) => {
                const chartCtx = chartInstance.ctx;
                chartCtx.save();
                chartCtx.font = `500 11px ${chartFontFamily}`;
                chartCtx.textBaseline = 'middle';
                chartCtx.textAlign = 'left';
                chartCtx.fillStyle = textColor;
                const padding = 8;

                chartInstance.data.datasets.forEach((dataset, i) => {
                    const meta = chartInstance.getDatasetMeta(i);
                    if (!meta.hidden) {
                        meta.data.forEach((bar, index) => {
                            const dataValue = dataset.data[index];
                            if (dataValue == null || dataValue === 0) return;

                            const displayValue = Number(dataValue).toLocaleString(undefined, { maximumFractionDigits: 1, minimumFractionDigits: 0 });
                            const textWidth = chartCtx.measureText(displayValue).width;
                            
                            const textX = bar.x + padding;
                            const textY = bar.y;
                            
                            if (textX + textWidth <= chartInstance.chartArea.right) {
                                chartCtx.fillText(displayValue, textX, textY);
                            }
                        });
                    }
                });
                chartCtx.restore();
            }
        },
        animation: {
            duration: 700,
            easing: 'easeOutQuart'
        },
        onHover: (event, chartElement) => {
            const canvas = event.native ? event.native.target : event.target;
            if (canvas) {
                canvas.style.cursor = chartElement.length ? 'pointer' : 'default';
            }
        }
    },
});
};


const updateDashboard = debounce(() => {
applyFilters();
updateStats();
updateMedicationChart();
if (isExploreMode) {
    updateExploreView();
}
if (isMissingMode) {
    updateMissingView();
}
updateResultsCount();
}, 150);

const toggleExploreMode = () => {
isExploreMode = !isExploreMode;
const exploreButton = document.getElementById('toggleExploreBtn');
const dashboardView = document.querySelector('.dashboard-view');
const exploreView = document.querySelector('.explore-view');
const missingView = document.querySelector('.missing-view');
const missingButton = document.getElementById('toggleMissingBtn');
const missingResultsCountElement = document.getElementById('missingResultsCount');
const exploreResultsCountElement = document.getElementById('exploreResultsCount');
const missingViewResultsCountElement = document.getElementById('missingViewResultsCount');


if (isExploreMode) {
    exploreButton.innerHTML = `<svg class="button-icon" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-10.293a1 1 0 00-1.414-1.414L10 8.586 7.707 6.293a1 1 0 00-1.414 1.414L8.586 10l-2.293 2.293a1 1 0 001.414 1.414L10 11.414l2.293 2.293a1 1 0 001.414-1.414L11.414 10l2.293-2.293z" clip-rule="evenodd" /></svg><span>Back</span>`;
    dashboardView.classList.add('hidden');
    missingView.classList.add('hidden');
    exploreView.classList.remove('hidden');
    if(exploreResultsCountElement) exploreResultsCountElement.classList.remove('hidden');
    if(missingResultsCountElement) missingResultsCountElement.classList.add('hidden');
    if(missingViewResultsCountElement) missingViewResultsCountElement.classList.add('hidden');


    missingButton.innerHTML = `<svg class="button-icon" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg><span>Missing</span>`;
    isMissingMode = false;
    updateExploreView();
} else {
    exploreButton.innerHTML = `<svg class="button-icon" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg><span>Explore</span>`;
    dashboardView.classList.remove('hidden');
    exploreView.classList.add('hidden');
    if(exploreResultsCountElement) exploreResultsCountElement.classList.add('hidden');

}
updateResultsCount();
};

const toggleMissingMode = () => {
isMissingMode = !isMissingMode;
const missingButton = document.getElementById('toggleMissingBtn');
const dashboardView = document.querySelector('.dashboard-view');
const exploreView = document.querySelector('.explore-view');
const missingView = document.querySelector('.missing-view');
const exploreButton = document.getElementById('toggleExploreBtn');
const missingResultsCountElement = document.getElementById('missingResultsCount');
const exploreResultsCountElement = document.getElementById('exploreResultsCount');
const missingViewResultsCountElement = document.getElementById('missingViewResultsCount');

if (isMissingMode) {
    missingButton.innerHTML = `<svg class="button-icon" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-10.293a1 1 0 00-1.414-1.414L10 8.586 7.707 6.293a1 1 0 00-1.414 1.414L8.586 10l-2.293 2.293a1 1 0 001.414 1.414L10 11.414l2.293 2.293a1 1 0 001.414-1.414L11.414 10l2.293-2.293z" clip-rule="evenodd" /></svg><span>Back</span>`;
    dashboardView.classList.add('hidden');
    exploreView.classList.add('hidden');
    missingView.classList.remove('hidden');
    if(missingViewResultsCountElement) missingViewResultsCountElement.classList.remove('hidden');
    if(exploreResultsCountElement) exploreResultsCountElement.classList.add('hidden');
    if(missingResultsCountElement) missingResultsCountElement.classList.add('hidden');


    exploreButton.innerHTML = `<svg class="button-icon" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg><span>Explore</span>`;
    isExploreMode = false;
    updateMissingView();
} else {
    missingButton.innerHTML = `<svg class="button-icon" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg><span>Missing</span>`;
    dashboardView.classList.remove('hidden');
    missingView.classList.add('hidden');
    if(missingViewResultsCountElement) missingViewResultsCountElement.classList.add('hidden');

}
updateResultsCount();
};


const resetFilters = () => {
const filters = ['region', 'pharmacy', 'month', 'class'];
filters.forEach((filter) => {
    const filterElement = document.getElementById(`${filter}Filter`);
    if (filterElement) filterElement.value = 'all';
});
filters.forEach((filter) => updateFilterOptions(filter, {}));
updateFilterHighlights();
updateDashboard();
};


const exportToCSV = (dataArray, filename) => {
const headers = [];
if (dataArray.length > 0) {
    Object.keys(dataArray[0]).forEach(key => {
        if (!headers.includes(key)) headers.push(key);
    });
}

let csvContent = '\ufeff';
csvContent += headers.join(',') + '\n';

dataArray.forEach(item => {
    const row = headers.map(header => {
        const value = item[header] === undefined || item[header] === null ? '' : String(item[header]);
        if (value.includes(',') || value.includes('"') || value.includes('\n')) {
            return `"${value.replace(/"/g, '""')}"`;
        }
        return value;
    });
    csvContent += row.join(',') + '\n';
});

const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
const link = document.createElement('a');
const url = URL.createObjectURL(blob);
link.setAttribute('href', url);
link.setAttribute('download', filename);
link.style.visibility = 'hidden';
document.body.appendChild(link);
link.click();
document.body.removeChild(link);
};

const exportData = () => {
let dataToExport;
let sheetName = 'Dashboard Data';
const currentFilters = getCurrentFilters();
let filterDesc = Object.entries(currentFilters)
    .filter(([key, value]) => value !== 'all')
    .map(([key, value]) => `${key}=${value}`)
    .join('_');
if (filterDesc) filterDesc = `_${filterDesc}`;


if (isExploreMode) {
    const months = Array.from(new Set(filteredData.map((row) => row.Month ? String(row.Month).trim() : row.Month)))
        .filter(Boolean)
        .sort((a, b) => getMonthOrderValue(a) - getMonthOrderValue(b));
    const metrics = ['Total', 'Total Prescriptions', 'Insurance Covered', 'Active Pharmacies', ...medicationCategories];
    const monthlyData = {};
    months.forEach((month) => {
        const monthDataFiltered = filteredData.filter((row) => (row.Month ? String(row.Month).trim() : row.Month) === month);
        monthlyData[month] = {
            Total: medicationCategories.reduce((sum, category) => sum + monthDataFiltered.reduce((catSum, row) => catSum + parseFloat(row[category] || 0), 0), 0),
            'Total Prescriptions': monthDataFiltered.reduce((sum, row) => sum + parseFloat(row['Total Prescription'] || 0), 0),
            'Insurance Covered': monthDataFiltered.reduce((sum, row) => sum + parseFloat(row['Insurance Covered Prescription'] || 0), 0),
            'Active Pharmacies': new Set(monthDataFiltered.map((row) => row.Pharmacy).filter(Boolean)).size,
            ...Object.fromEntries(medicationCategories.map((category) => [category, monthDataFiltered.reduce((sum, row) => sum + parseFloat(row[category] || 0), 0)])),
        };
    });
    dataToExport = metrics.map(metric => {
        const row = { Metric: metric };
        months.forEach(month => {
            row[month] = monthlyData[month][metric];
        });
        return row;
    }).filter(row => {
        if (['Total', 'Total Prescriptions', 'Insurance Covered', 'Active Pharmacies'].includes(row.Metric)) return true;
        return Object.values(row).slice(1).some(val => val !== 0 && val !== undefined);
    });
    sheetName = 'Explore View';
} else if (isMissingMode) {
    dataToExport = missingData;
    sheetName = 'Missing Data';
} else {
    dataToExport = filteredData;
    sheetName = 'Filtered Data';
}


const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
const filename = `pharmacy_export_${sheetName.replace(/\s/g, '')}${filterDesc}_${timestamp}`;

if (dataToExport.length === 0) {
    alert("No data to export for the current view/filters.");
    return;
}

try {
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(dataToExport, { codepage: 65001 });
    XLSX.utils.book_append_sheet(wb, ws, sheetName);
    try {
        XLSX.writeFile(wb, `${filename}.xlsx`);
    } catch (excelError) {
        exportToCSV(dataToExport, `${filename}.csv`);
        const notification = document.createElement('div');
        notification.textContent = 'Excel export failed. Data exported as CSV instead.';
        Object.assign(notification.style, { position: 'fixed', bottom: '20px', right: '20px', backgroundColor: '#f8d7da', color: '#721c24', padding: '10px 15px', borderRadius: '4px', boxShadow: '0 2px 5px rgba(0,0,0,0.2)', zIndex: '1000' });
        document.body.appendChild(notification);
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transition = 'opacity 0.5s ease';
            setTimeout(() => document.body.removeChild(notification), 500);
        }, 5000);
    }
} catch (error) {
    exportToCSV(dataToExport, `${filename}.csv`);
}
};

document.addEventListener('DOMContentLoaded', () => {
document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);
document.getElementById('toggleExploreBtn').addEventListener('click', toggleExploreMode);
document.getElementById('toggleMissingBtn').addEventListener('click', toggleMissingMode);
document.getElementById('exportExcelBtn').addEventListener('click', exportData);

const SHEET_ID = '122uThrt83Vs8rUtOe4PCmsWjLSxv8A-OmUbT0Y3PZeg';
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv`;
fetch(SHEET_URL)
.then((response) => {
if (!response.ok) throw new Error('Network response was not ok');
return response.text();
})
.then((csvText) => {
Papa.parse(csvText, {
    header: true,
    encoding: 'UTF-8',
    skipEmptyLines: true,
    complete: function (results) {
        data = results.data.map(row => {
            const newRow = {};
            for (const key in row) {
                if (Object.prototype.hasOwnProperty.call(row, key)) {
                    const trimmedKey = String(key).trim();
                    newRow[trimmedKey] = typeof row[key] === 'string' ? String(row[key]).trim() : row[key];
                }
            }
            return newRow;
        }).filter(row => row && Object.values(row).some(val => val !== null && val !== '' && val !== undefined));


        const uniquePharmacies = new Set(data.map(row => row.Pharmacy).filter(Boolean));
        totalUniquePharmaciesAllData = uniquePharmacies.size;

        filteredData = [...data];
        initializeFilters();
        updateDashboard();
    },
    error: function (err) {
        console.error('Error parsing CSV: ', err);
        document.getElementById('statsContainer').innerHTML = `<div class="stat-card danger-card"><div class="stat-card-content"><div class="stat-value">Error</div><div class="stat-label">Failed to parse CSV data.</div></div></div>`;
    },
});
})
.catch((error) => {
console.error('Error fetching or parsing data:', error);
document.getElementById('statsContainer').innerHTML = `<div class="stat-card danger-card"><div class="stat-card-content"><div class="stat-value">Error</div><div class="stat-label">Failed to load data. Check connection & refresh.</div></div></div>`;
});
});
</script>

</body>
</html>
